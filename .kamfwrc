# shellcheck shell=ash
##########################################################################################
#
# KAM framework- Cross-Root Manager Utility Library
# 跨 Root 管理器工具框架--模块开发辅助库
#
##########################################################################################
export MODDIR=${MODPATH:-${0%/*}}
# 环境变量
export PATH=${MODDIR}/.local/bin/:$PATH：/data/data/com.termux/files/usr/bin:/data/data/com.termux/files/usr/bin
export LD_LIBRARY_PATH=${MODDIR}/.local/lib/:$LD_LIBRARY_PATH:/data/data/com.termux/files/usr/lib
export HOME=${MODDIR}

export KAMFW_DIR=${MODDIR}/lib/kamfw
export KAM_MODULES=${KAM_MODULES:-""}

# =============================================================================
# 基础函数
# =============================================================================
# ui_print plus
print() {
    _print_msg="$1"
    printf '%b\n' "$_print_msg"

    if [ -n "${OUTFD:-}" ] && [ -e "/proc/self/fd/$OUTFD" ]; then
        _print_clean_msg=$(printf '%b' "$_print_msg" | sed 's/\x1b\[[0-9;]*m//g')
        printf 'ui_print %s\n' "$_print_clean_msg" >&"$OUTFD"
        printf 'ui_print \n' >&"$OUTFD"
    fi
}

# =============================================================================
# 内部API
# =============================================================================

_kamfw_load () {
    _kamfw_load_name=$1

    _kamfw_load_path=${KAMFW_DIR}/$1.sh
    case " ${KAM_MODULES} " in
        *" ${_kamfw_load_name} "*)
            return 0
            ;;
    esac

    if [ -f "$_kamfw_load_path" ]; then
        source "$_kamfw_load_path"
    else
        print "Error: Module '$1' not found"
    fi
}


_kamfw_list () {
    print "Available modules:"
    for module in ${KAM_MODULES}; do
        print "  $module"
    done
}

_kamfw_help () {
    print "Usage: kamfw <command>"
    print "Commands:"
    print "  load <module>"
    print "  unload <module>"
    print "  list"
    print "  help"
}

# =============================================================================
# 工具加载库
# =============================================================================

kamfw() {
    # 指令：
    # load 加载子模块
    # unload 卸载子模块
    # list 列出所有子模块
    # help 显示帮助信息
    case "$1" in
        load)
            shift
            _kamfw_load "$@"
            ;;
        list)
            _kamfw_list
            ;;
        *)
            _kamfw_help
            ;;

    esac
}

import() { kamfw load "$@"; }

if [ -n "${PS1:-}" ]; then
  alias import='kamfw load'
fi
