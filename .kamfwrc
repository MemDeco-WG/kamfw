# shellcheck shell=ash
##########################################################################################
#
# KAM framework- Cross-Root Manager Utility Library
# 跨 Root 管理器工具框架--模块开发辅助库
#
##########################################################################################
export MODDIR=${MODPATH:-${0%/*}}

# 环境变量

export HOME=${MODDIR}

export KAMFW_DIR=${MODDIR}/lib/kamfw
export KAM_MODULES=${KAM_MODULES:-""}

export KAM_LOGFILE=${MODDIR}/kam.log

# Load persisted language override (if present).
# This file is written by the `select_language` helper (created below).
# When present it will export `KAM_LANG` so the i18n system picks it up.
if [ -f "${KAMFW_DIR}/.kamfw_lang" ]; then
    . "${KAMFW_DIR}/.kamfw_lang"
fi
# =============================================================================
# 实验区域
# =============================================================================


# =============================================================================
# 基础函数
# =============================================================================

# terminal print (tty)
tprint() {
    [ -t 1 ] || return 0
    printf '%s\n' "$@" 
}

# GUI print (not tty)
gprint() {
    [ -t 1 ] && return 0
    printf '%s\n' "$@"
}
# ui_print plus
print() {
     _print_msg="$1"
     if [ "${BOOTMODE:-true}" = true ]; then
         tprint "$_print_msg"
         gprint "$_print_msg"
     else
         if [ -n "${OUTFD:-}" ] && [ -e "/proc/self/fd/$OUTFD" ]; then
             printf 'ui_print %s\nui_print\n' "$_print_msg" >&"$OUTFD"
         fi
     fi
}

# =============================================================================
# 内部API
# =============================================================================

_kamfw_load () {
    _kamfw_load_name=$1

    _kamfw_load_path=${KAMFW_DIR}/$1.sh
    case " ${KAM_MODULES} " in
        *" ${_kamfw_load_name} "*)
            return 0
            ;;
    esac

    if [ -f "$_kamfw_load_path" ]; then
        source "$_kamfw_load_path"
    else
        print "Error: Module '$1' not found"
    fi
}

_kamfw_list () {
    print "Available modules:"
    for module in ${KAM_MODULES}; do
        print "  $module"
    done
}

_kamfw_help () {
    print "Usage: kamfw <command>"
    print "Commands:"
    print "  load <module>"
    print "  unload <module>"
    print "  list"
    print "  help"
}

# =============================================================================
# 工具加载库
# =============================================================================

kamfw() {
    # 指令：
    # load 加载子模块
    # unload 卸载子模块
    # list 列出所有子模块
    # help 显示帮助信息
    case "$1" in
        load)
            shift
            _kamfw_load "$@"
            ;;
        list)
            _kamfw_list
            ;;
        *)
            _kamfw_help
            ;;

    esac
}

import() { kamfw load "$@"; }

[ -t 0 ] && alias import='kamfw load'

# =============================================================================
# INIT
# =============================================================================

import base
import i18n

if is_magisk; then
    import magisk
fi

if is_ksu; then
    import ksu
fi

if is_ap; then
    import ap
fi


